<!DOCTYPE html>
<html lang="ch">
<head>
    <meta charset="UTF-8">
    <title>æ•°æ®ç»´æŠ¤ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/nav.css">
    <link rel="stylesheet" href="/css/data-maintain.css">
</head>
<body>
<div id="nav-container"></div>

<!-- é€šç”¨æ•°æ®ç»´æŠ¤æ¡†æ¶å®¹å™¨ -->
<div class="data-maintain-frame">
    <!-- ä¾§è¾¹æ å¯¼èˆª -->
    <div class="sidebar">
        <div class="menu-group">
            <div class="menu-title">æ•°æ®ç»´æŠ¤é¡¹</div>
            <ul class="submenu">
                <li class="active" data-module="department-manager">
                    <a href="javascript:void(0)">â–¶ éƒ¨é—¨è´Ÿè´£äºº</a>
                </li>
                <!-- é¢„ç•™å…¶ä»–ç»´æŠ¤é¡¹æ’æ§½ -->
                <li class="menu-placeholder">æ›´å¤šç»´æŠ¤åŠŸèƒ½å¼€å‘ä¸­...</li>
            </ul>
        </div>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="main-content">
        <!-- éƒ¨é—¨è´Ÿè´£äººç»´æŠ¤æ¨¡å— -->
        <div class="module-container active" id="department-manager">
            <div class="module-header">
                <h2><span class="icon">ğŸ“‹</span> éƒ¨é—¨è´Ÿè´£äººç»´æŠ¤</h2>
                <div class="toolbar">
                    <button class="btn-sync" onclick="syncDepartments()">åŒæ­¥éƒ¨é—¨</button>
                    <button class="btn-refresh" onclick="loadManagers()">åˆ·æ–°æ•°æ®</button>
                </div>
            </div>

            <table class="data-table">
                <thead>
                <tr>
                    <th width="25%">éƒ¨é—¨åç§°</th>
                    <th width="20%">åˆ›å»ºæ—¶é—´</th>
                    <th width="20%">æœ€åæ›´æ–°</th>
                    <th width="25%">éƒ¨é—¨è´Ÿè´£äºº</th>
                    <th width="10%">æ“ä½œ</th>
                </tr>
                </thead>
                <tbody id="managerTableBody"></tbody>
            </table>
        </div>

        <!-- é¢„ç•™å…¶ä»–æ¨¡å—å®¹å™¨ -->
        <div class="module-placeholder">
            <div class="empty-state">
                <div class="icon">ğŸ“</div>
                <p>é€‰æ‹©å·¦ä¾§èœå•å¼€å§‹æ•°æ®ç»´æŠ¤</p>
            </div>
        </div>
    </div>
</div>

<!-- å¼•å…¥å…¬å…±è„šæœ¬ -->
<script src="/js/common.js"></script> <!-- å¿…é¡»æ”¾åœ¨é¦–ä½ -->
<script src="/js/nav-loader.js"></script>
<script src="/js/data-maintain.js"></script> <!-- å…ˆåŠ è½½é€šç”¨é€»è¾‘ -->
<script src="/js/manager.js"></script>      <!-- ååŠ è½½æ¨¡å—ä¸“å±é€»è¾‘ -->

<script>
    // éƒ¨é—¨è´Ÿè´£äººç»´æŠ¤ä¸“å±é€»è¾‘
    function loadManagers() {
        fetch('/api/department-manager')
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById('managerTableBody');
                tbody.innerHTML = data.map(item => `
                    <tr>
                        <td>${item.departmentName}</td>
                        <td>${new Date(item.createdAt).toLocaleString()}</td>
                        <td>${item.updatedAt ? new Date(item.updatedAt).toLocaleString() : '-'}</td>
                        <td>
                            <input type="text"
                                   value="${item.departmentLeader || ''}"
                                   data-original="${item.departmentLeader || ''}"
                                   onchange="toggleSaveButton(this)">
                        </td>
                        <td>
                            <button class="btn-save"
                                    onclick="saveManager('${item.departmentName}', this)"
                                    disabled>ä¿å­˜</button>
                        </td>
                    </tr>
                `).join('');
            });
    }

    function toggleSaveButton(input) {
        const btn = input.closest('tr').querySelector('.btn-save');
        btn.disabled = input.value === input.dataset.original;
    }

    function saveManager(departmentName, btn) {
        const input = btn.closest('tr').querySelector('input');
        fetch('/api/department-manager', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                departmentName: departmentName,
                departmentLeader: input.value
            })
        }).then(() => {
            input.dataset.original = input.value;
            btn.disabled = true;
            showToast('âœ… æ•°æ®ä¿å­˜æˆåŠŸ');
        }).catch(() => showToast('âŒ ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ'));
    }

    // åˆå§‹åŒ–åŠ è½½
    document.addEventListener('DOMContentLoaded', loadManagers);
</script>
</body>
</html>